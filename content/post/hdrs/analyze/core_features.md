---
title: "灾备核心技术"
categories: ["analyze"]
tags: [""]
date: 2020-08-23T15:54:00+00:00
---

# 灾备核心技术

如果以两个字分别来描述备份和容灾的核心技术，那备份就是**副本**，容灾就是**复制**。

## 备份

### 备份副本管理

备份最核心的特性莫过于副本管理。从经济性和效率角度看，不可能每次都保存全量数据。因此每次只能备份差量数据，这个差量数据与全量数据的依赖关系如何定义是最核心的特性。每个数据块形成一个hash，通过hash对比是否是同一块数据。每个副本有自己的数据链，记录依赖了哪些数据块，数据块通过索引来记录每块数据是否被其他副本引用。

### 差量数据获取

基于块的备份差量数据是从快照中获取的，比较两次备份间的快照，获取差量位图卷，将该卷挂载到备份代理节点进行读取。

### 重删

减少备份数据量是降低成本最直接的手段，重删又是减少数据量的不二法门。

### 即时恢复LazyLoading

IO以操作系统发送给块存储设备，块存储通过备份sdk从对象存储中读取备份数据实现按需加载。

## 容灾

### 数据传输协议及实现

每三分之一RPO时间或者到达一定数据量（5MB）形成一个dataset，后续所有的数据处理均基于该逻辑概念。

下一个dataset开始时处理上一个dataset，时间上错开，避免内存的迸发访问。

### 业务数据获取

通过替换内核`blockdev`的`make_request_fn`实现`bio`的抓取，使用`COW(copy on write)`的方式将IO拷贝一份出来发送出去。

### CDP

CDP本质上就是快照加重放。每个dataset都记录时间。

### LazyLoading

直接从CDP时间点中启动卷，加快演练、切换速度。

